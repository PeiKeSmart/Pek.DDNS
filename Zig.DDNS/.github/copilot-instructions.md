# PeiKeSmart Copilot 协作指令

本说明适用于沛柯智能（PeiKeSmart）及其全部开源 / 衍生项目。本指令用于规范在这些项目中使用 Copilot（及类似智能助手）时的行为，主要面向 Zig 0.15.1及以上 技术栈。

## 1. 目标
- 提效：减少机械样板劳动，聚焦业务/核心算法。
- 一致：风格、结构、命名、API 行为稳定。
- 可控：限制改动影响面、可审计、兼容友好、不引入隐患。
- 可靠：避免虚构、保持性能、不破坏现有合约。

## 2. 适用范围
- 含 PeiKeSmart 组件或其衍生的全部 Zig 仓库。
- 不含纯前端 / 非 Zig / 市场文案。
- 存在本文件 → 必须遵循；缺失可引入。

## 3. 角色与职责
- 开发者：提出清晰需求（功能/缺陷/性能/重构/文档）。
- Copilot：先检索再生成；输出必要且影响面受控的改动；不虚构；简体中文回复。
- 审核关键点：公共 API、一致性、性能影响。

## 4. 工作流
1) 需求分类 → 功能 / 修复 / 性能 / 重构 / 文档  
2) 检索 → 相关类型、目录、方法、已有扩展/工具  
3) 评估 → 是否公共 API / 是否性能热点  
4) 设计 → 列出改动点 + 兼容/降级策略  
5) 实施 → 局部编辑，限制改动影响面；保留原注释与结构  
6) 验证 → 通过编译；自动运行与本次改动相关的单元测试；若未发现任何相关测试，在结果中明确说明；不得自动新增测试项目  
7) 说明 → 变更摘要 / 影响范围  
8) 提交 → 统一格式，整理中文提交日志；禁止夹带无关格式化

## 5. 编码规范
- 忌全量重排、无差异格式化提交。
- 禁止擅自删除已有代码注释（含单行 // 与 XML 文档注释），可以修改或追加；禁止单独“清理”一片注释块或仅删除空白行来制造差异。
- 不得仅为对齐或所谓美观批量移除、合并空白行；保留有意的逻辑分隔空行。仅在同一局部有真实代码增删且需要保持统一时才可适度调整。

### 5.1 可读性优先（就近）
- 局部变量就近声明：在首次使用前的最近位置声明，避免集中在方法开头。
- 成组排布：相关成员按依赖顺序成组摆放，降低跳转成本。
- 合理例外：如会导致重复声明、闭包捕获或影响性能/生命周期，可权衡位置并加简短注释。

冲突时以“易读易懂”为先。

## 6. 文档注释
- 示例可裁剪；避免泄露密钥、真实内部地址。

## 7. 异步与性能

## 8. 日志与追踪

## 9. 错误处理

## 10. 测试

## 11. Copilot 使用守则
- 仅回答开发相关；非开发 → “我是编程助手”。
- 输出前检索；禁止重复造轮子。
- 不生成超出需求的大块模板，先列方案再实现。
- 不新增外部依赖（除非说明内置不足并给出权衡）。
- 遇不确定上下文 → 标记“需查看文件”。
- 不伪造：测试结果 / 性能数据 / 外部调用。
- 回答或修改代码时，不得移除已有注释文本，可以修改或追加；不得单独删除整段注释或仅删除空白行制造“格式优化”式提交。
- 进行循环、控制流结构调整时，若原代码含循环花括号（即便单语句体），须保留，不得擅自移除。
- 修改或提交代码后，需自动在本地运行与改动相关的单元测试并确保通过；若无法定位相关测试，再运行最小必要集合或全部；若未找到任何测试，需在结果中明确说明且不自动新增测试项目。
- 生成文档：未特别指明时，默认以 Markdown（.md）格式输出，并使用 UTF-8 编码。

## 12. 变更与审核说明
提交或答复需包含：
- 概述：做了什么 / 为什么
- 影响：公共 API？性能？
- 兼容：降级策略 / 条件编译点
- 风险：潜在回归 / 性能开销
- 后续：是否补测试 / 文档

## 13. 禁止清单
- 虚构 API / 文件 / 类型
- 未检索即重写或重复实现
- 擅自删除公共 / 受保护成员
- 引入重复第三方功能库
- 伪造测试/性能数据
- 在热点路径添加高分配 LINQ/反射（无缓存）
- 输出敏感凭据/内部地址
- 未审计第三方片段直接贴入
- 将非确定性行为直接断言（时间/随机）不隔离
- 强行异步化纯同步逻辑
- 大面积格式化无业务价值
- 擅自删除已有代码注释
- 仅删除或合并空白行以制造“变化”

## 14. 术语说明
- 热点路径：经性能分析或高频调用栈确认的关键执行段。
- 基线：变更前的功能/性能参考数据。

---
（完）